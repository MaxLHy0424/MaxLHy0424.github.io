---
import { siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";
import { Icon } from "astro-icon/components";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

const monthNames = [
	i18n(I18nKey.calendarJanuary),
	i18n(I18nKey.calendarFebruary),
	i18n(I18nKey.calendarMarch),
	i18n(I18nKey.calendarApril),
	i18n(I18nKey.calendarMay),
	i18n(I18nKey.calendarJune),
	i18n(I18nKey.calendarJuly),
	i18n(I18nKey.calendarAugust),
	i18n(I18nKey.calendarSeptember),
	i18n(I18nKey.calendarOctober),
	i18n(I18nKey.calendarNovember),
	i18n(I18nKey.calendarDecember),
];

const weekDays = [
	i18n(I18nKey.calendarMonday),
	i18n(I18nKey.calendarTuesday),
	i18n(I18nKey.calendarWednesday),
	i18n(I18nKey.calendarThursday),
	i18n(I18nKey.calendarFriday),
	i18n(I18nKey.calendarSaturday),
	i18n(I18nKey.calendarSunday),
];

const isChinese = siteConfig.lang.startsWith("zh");
const yearSuffix = isChinese ? "年" : " ";
---

<WidgetLayout
	id="calendar-widget"
	class={`hidden md:block ${className}`}
	style={style}
>
	<div class="flex justify-between items-center mb-2 mt-2">
		<div
			class="font-bold transition text-lg text-90 relative ml-4 flex items-center
					before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
					before:absolute before:left-[-16px] before:top-[13.5px]"
		>
			<div
				id="calendar-title-container"
				class="flex justify-center items-center cursor-pointer hover:bg-(--btn-plain-bg-hover) px-2 py-2 -ml-2 rounded-lg transition-colors"
			>
				<span
					id="calendar-title"
					class="text-lg font-bold text-90 select-none"
				></span>
			</div>
		</div>

		<div class="flex items-center gap-1 shrink-0 ml-2">
			<button
				id="back-to-today-btn"
				class="p-1.5 rounded-md hover:bg-(--btn-plain-bg-hover) text-(--primary) transition-all invisible"
				aria-label="Back to today"
			>
				<Icon
					name="material-symbols:restart-alt-rounded"
					class="text-xl"
				/>
			</button>
			<button
				id="prev-month-btn"
				class="p-1.5 rounded-md hover:bg-(--btn-plain-bg-hover) text-75 hover:text-(--primary) transition-colors text-xl font-extrabold"
				aria-label="Previous month"
			>
				＜
			</button>
			<button
				id="next-month-btn"
				class="p-1.5 rounded-md hover:bg-(--btn-plain-bg-hover) text-75 hover:text-(--primary) transition-colors text-xl font-extrabold"
				aria-label="Next month"
			>
				＞
			</button>
		</div>
	</div>
	<div class="relative w-full overflow-hidden" style="min-height: 15.625rem;">
		<div id="calendar-view" class="w-full opacity-100">
			<div class="grid grid-cols-7 gap-1 mb-2">
				{
					weekDays.map((day) => (
						<div class="text-center text-xs text-50 font-medium py-1">
							{day}
						</div>
					))
				}
			</div>
			<div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
			<div id="calendar-posts" class="mt-4">
				<div
					class="h-px w-full bg-(--line-divider) mb-2 hidden"
					id="calendar-posts-divider"
				>
				</div>
				<div
					class="flex flex-col gap-1 max-h-37.5 overflow-y-auto custom-scrollbar"
					id="calendar-posts-list"
				>
				</div>
			</div>
		</div>
		<div
			id="selection-panel"
			class="absolute inset-0 bg-(--card-bg) z-10 flex flex-col hidden opacity-0 transition-opacity duration-200"
		>
			<div
				id="selection-content"
				class="w-full h-full overflow-y-auto custom-scrollbar p-2 grid gap-2 content-start"
			>
			</div>
		</div>
	</div>
</WidgetLayout>

<script
	is:inline
	define:vars={{
		monthNames,
		yearSuffix,
	}}
>
	let allPostsData = [];
	const postDateMap = {};
	const postsByMonth = {};
	const stats = {
		hasPostInYear: {},
		hasPostInMonth: {},
		minYear: new Date().getFullYear(),
		maxYear: new Date().getFullYear() + 5,
	};

	async function fetchCalendarData() {
		try {
			const res = await fetch("/api/calendar-data.json");
			const data = await res.json();
			if (Array.isArray(data)) {
				allPostsData = data;
				processPostsData(allPostsData);
				const currentPostId = getCurrentPostId();
				if (currentPostId) {
					const matchedPost = allPostsData.find(
						(p) => p.id === currentPostId,
					);
					if (matchedPost) {
						const [y, m] = matchedPost.date.split("-");
						currentYear = parseInt(y);
						currentMonth = parseInt(m) - 1;
					}
				}
				renderCalendar();
			}
		} catch (error) {
			console.error("Failed to fetch calendar data:", error);
		}
	}

	function processPostsData(posts) {
		if (!posts || posts.length === 0) return;
		posts.forEach((post) => {
			const [yStr, mStr] = post.date.split("-");
			const year = parseInt(yStr);
			const month = parseInt(mStr); // 1-12
			stats.hasPostInYear[year] = true;
			stats.hasPostInMonth[`${year}-${month}`] = true;

			if (year < stats.minYear) stats.minYear = year;

			const dateKey = post.date;
			const monthKey = `${year}-${month - 1}`; // JS Month is 0-11

			if (!postDateMap[dateKey]) postDateMap[dateKey] = [];
			postDateMap[dateKey].push(post);

			if (!postsByMonth[monthKey]) postsByMonth[monthKey] = [];
			postsByMonth[monthKey].push(post);
		});
	}

	const now = new Date();
	const todayYear = now.getFullYear();
	const todayMonth = now.getMonth();
	const todayDate = now.getDate();

	let currentYear = todayYear;
	let currentMonth = todayMonth;
	let selectedDateKey = null;
	let currentView = "day";

	const dom = {
		titleContainer: document.getElementById("calendar-title-container"),
		title: document.getElementById("calendar-title"),
		prevBtn: document.getElementById("prev-month-btn"),
		nextBtn: document.getElementById("next-month-btn"),
		backTodayBtn: document.getElementById("back-to-today-btn"),
		calendarView: document.getElementById("calendar-view"),
		selectionPanel: document.getElementById("selection-panel"),
		selectionContent: document.getElementById("selection-content"),
		grid: document.getElementById("calendar-grid"),
		postsList: document.getElementById("calendar-posts-list"),
		divider: document.getElementById("calendar-posts-divider"),
	};

	function getCurrentPostId() {
		const path = window.location.pathname;
		if (!allPostsData || allPostsData.length === 0) return null;
		const decodedPath = decodeURIComponent(path);
		const normalizedPath = decodedPath.endsWith("/")
			? decodedPath.slice(0, -1)
			: decodedPath;

		const matchedPost = allPostsData.find((post) => {
			return normalizedPath.endsWith(`/${post.id}`);
		});
		return matchedPost ? matchedPost.id : null;
	}

	function init() {
		renderCalendar();
		setupEventListeners();
		fetchCalendarData();
	}

	function setupEventListeners() {
		dom.titleContainer.addEventListener("click", (e) => {
			e.stopPropagation();
			if (currentView === "day") showMonthPicker();
			else if (currentView === "month") showYearPicker();
			else closeSelectionPanel();
		});

		dom.prevBtn.addEventListener("click", () => {
			currentMonth--;
			if (currentMonth < 0) {
				currentMonth = 11;
				currentYear--;
			}
			renderCalendar();
		});

		dom.nextBtn.addEventListener("click", () => {
			currentMonth++;
			if (currentMonth > 11) {
				currentMonth = 0;
				currentYear++;
			}
			renderCalendar();
		});

		dom.backTodayBtn.addEventListener("click", () => {
			currentYear = todayYear;
			currentMonth = todayMonth;
			selectedDateKey = null;
			if (currentView !== "day") closeSelectionPanel();
			else renderCalendar();
		});

		dom.grid.addEventListener("click", (e) => {
			const cell = e.target.closest(".calendar-day");
			if (!cell) return;
			const dateKey = cell.getAttribute("data-date");

			if (selectedDateKey === dateKey) selectedDateKey = null;
			else selectedDateKey = dateKey;

			renderCalendar();
			if (selectedDateKey && postDateMap[selectedDateKey]) {
				renderPostList(postDateMap[selectedDateKey]);
			} else {
				showMonthlyPosts();
			}
		});

		dom.selectionContent.addEventListener("click", (e) => {
			const monthItem = e.target.closest(".month-item");
			const yearItem = e.target.closest(".year-item");

			if (monthItem) {
				e.stopPropagation();
				currentMonth = parseInt(monthItem.getAttribute("data-month"));
				closeSelectionPanel();
			} else if (yearItem) {
				e.stopPropagation();
				currentYear = parseInt(yearItem.getAttribute("data-year"));
				showMonthPicker();
			}
		});

		document.addEventListener("click", (e) => {
			if (currentView === "day") return;
			const widget = document.getElementById("calendar-widget");
			if (widget && !widget.contains(e.target)) {
				closeSelectionPanel();
			}
		});
	}

	function updateHeader() {
		dom.title.textContent = `${currentYear}${yearSuffix} ${monthNames[currentMonth]}`;
		const isCurrentRealMonth =
			currentYear === todayYear && currentMonth === todayMonth;
		const shouldShowReset = !isCurrentRealMonth || selectedDateKey !== null;

		if (shouldShowReset) dom.backTodayBtn.classList.remove("invisible");
		else dom.backTodayBtn.classList.add("invisible");

		// const isDayView = currentView === "day";
		// dom.prevBtn.style.visibility = isDayView ? "visible" : "hidden";
		// dom.nextBtn.style.visibility = isDayView ? "visible" : "hidden";
	}

	function renderCalendar() {
		updateHeader();
		const firstDayOfMonth =
			(new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
		const daysInMonth = new Date(
			currentYear,
			currentMonth + 1,
			0,
		).getDate();

		let html = "";
		if (firstDayOfMonth > 0) {
			html += `<div class="aspect-square"></div>`.repeat(firstDayOfMonth);
		}

		for (let day = 1; day <= daysInMonth; day++) {
			const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
			const posts = postDateMap[dateKey] || [];
			const hasPost = posts.length > 0;
			const count = posts.length;
			const isToday =
				currentYear === todayYear &&
				currentMonth === todayMonth &&
				day === todayDate;
			const isSelected = selectedDateKey === dateKey;

			let bgClass =
				"hover:bg-(--btn-plain-bg-hover) text-75 border border-transparent";

			if (isSelected) {
				bgClass =
					"bg-(--primary) text-white shadow-md border border-transparent";
			} else if (isToday) {
				bgClass =
					"text-(--primary) font-bold bg-(--primary)/10 border border-(--primary)";
			} else if (hasPost) {
				bgClass =
					"font-bold text-90 hover:bg-(--btn-plain-bg-hover) border border-transparent";
			}

			html += `
                <div class="calendar-day aspect-square flex items-center justify-center rounded-md cursor-pointer relative transition-all duration-200 ${bgClass}"
                    data-date="${dateKey}">
                    ${day}
                    ${hasPost && !isSelected ? `<span class="absolute bottom-1 w-1 h-1 rounded-full bg-(--primary)"></span>` : ""}
                    ${hasPost && count > 1 ? `<span class="absolute top-0.5 right-0.5 text-[9px] opacity-70 scale-75">${count}</span>` : ""}
                </div>
            `;
		}

		dom.grid.innerHTML = html;
		if (selectedDateKey && postDateMap[selectedDateKey]) {
			renderPostList(postDateMap[selectedDateKey]);
		} else {
			showMonthlyPosts();
		}
	}

	function showMonthlyPosts() {
		const key = `${currentYear}-${currentMonth}`; // Month is 0-11
		const posts = postsByMonth[key] || [];
		renderPostList(posts);
	}

	function renderPostList(posts) {
		if (!dom.postsList) return;
		if (posts.length === 0) {
			dom.divider.classList.add("hidden");
			dom.postsList.innerHTML = "";
			return;
		}

		dom.divider.classList.remove("hidden");
		const currentPostId = getCurrentPostId();

		const listHtml = posts
			.map((post) => {
				const [, m, d] = post.date.split("-");
				const dateStr = `${parseInt(m)}-${parseInt(d)}`;

				const isCurrentPost = post.id === currentPostId;
				let containerClass =
					"flex items-center justify-between text-sm transition-colors px-2 py-2 rounded-lg group border border-transparent";
				let titleClass = "truncate flex-1 font-bold transition-colors";
				let dateClass =
					"text-xs ml-2 whitespace-nowrap transition-colors";

				if (isCurrentPost) {
					containerClass +=
						" bg-(--primary)/10 text-(--primary) border-(--primary)/10";
					dateClass += " text-(--primary)/80";
				} else {
					containerClass +=
						" text-neutral-700 dark:text-neutral-300 hover:text-(--primary) dark:hover:text-(--primary) hover:bg-(--btn-plain-bg-hover)";
					dateClass +=
						" text-neutral-400 group-hover:text-(--primary)/70";
				}

				return `
            <a href="/posts/${post.id}/" class="${containerClass}">
                <span class="${titleClass}">${post.title}</span>
                <span class="${dateClass}">${dateStr}</span>
            </a>
        `;
			})
			.join("");

		dom.postsList.innerHTML = listHtml;
	}

	function showMonthPicker() {
		currentView = "month";
		updateHeader();
		dom.selectionPanel.classList.remove("hidden");
		requestAnimationFrame(() => {
			dom.selectionPanel.classList.remove("opacity-0");
		});

		dom.selectionContent.className =
			"w-full h-full p-4 grid grid-cols-3 gap-3 content-center";

		let html = "";
		monthNames.forEach((name, index) => {
			const isCurrentMonth = index === currentMonth;
			const hasPost = stats.hasPostInMonth[`${currentYear}-${index + 1}`];
			let cls =
				"month-item cursor-pointer rounded-lg flex flex-col items-center justify-center p-2 transition-all hover:bg-(--btn-plain-bg-hover) relative border border-transparent";
			if (isCurrentMonth)
				cls +=
					" border-(--primary) text-(--primary) bg-(--primary)/5";
			else cls += " text-neutral-700 dark:text-neutral-300";

			html += `
                <div class="${cls}" data-month="${index}">
                    <span class="text-sm font-bold">${name}</span>
                    ${hasPost ? `<span class="w-1 h-1 rounded-full bg-(--primary) mt-1"></span>` : `<span class="w-1 h-1 mt-1"></span>`}
                </div>
             `;
		});
		dom.selectionContent.innerHTML = html;
	}

	function showYearPicker() {
		currentView = "year";
		updateHeader();
		dom.selectionContent.className =
			"w-full h-full p-2 grid grid-cols-4 gap-2 content-start overflow-y-auto";

		let html = "";
		for (let y = stats.minYear; y <= stats.maxYear; y++) {
			const isCurrent = y === currentYear;
			const hasPost = stats.hasPostInYear[y];
			let cls =
				"year-item cursor-pointer rounded-lg flex flex-col items-center justify-center py-3 transition-all hover:bg-(--btn-plain-bg-hover) relative border border-transparent";
			if (isCurrent)
				cls +=
					" border-(--primary) text-(--primary) bg-(--primary)/5";
			else cls += " text-neutral-700 dark:text-neutral-300";

			html += `
                <div class="${cls}" data-year="${y}" id="year-${y}">
                    <span class="text-sm font-bold">${y}</span>
                     ${hasPost ? `<span class="w-1.5 h-1.5 rounded-full bg-(--primary) mt-1"></span>` : `<span class="w-1.5 h-1.5 mt-1"></span>`}
                </div>
            `;
		}
		dom.selectionContent.innerHTML = html;

		setTimeout(() => {
			const el = document.getElementById(`year-${currentYear}`);
			if (el) el.scrollIntoView({ block: "center", behavior: "smooth" });
		}, 50);
	}

	function closeSelectionPanel() {
		dom.selectionPanel.classList.add("opacity-0");
		setTimeout(() => {
			dom.selectionPanel.classList.add("hidden");
			currentView = "day";
			renderCalendar();
		}, 200);
	}

	init();
</script>

<style>
	.custom-scrollbar::-webkit-scrollbar {
		width: 4px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		background: transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		background-color: rgba(156, 163, 175, 0.5);
		border-radius: 2px;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb:hover {
		background-color: rgba(156, 163, 175, 0.8);
	}
</style>
