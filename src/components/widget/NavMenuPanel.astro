---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { LinkPreset, type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	links: NavBarLink[];
}

// 国际化标题映射
const navTitleMap: Record<string, string> = {
	Links: I18nKey.navLinks,
	My: I18nKey.navMy,
	About: I18nKey.navAbout,
	Others: I18nKey.navOthers,
	Anime: I18nKey.anime,
	Diary: I18nKey.diary,
	Gallery: I18nKey.albums,
	Devices: I18nKey.devices,
	Projects: I18nKey.projects,
	Skills: I18nKey.skills,
	Timeline: I18nKey.timeline,
	Friends: I18nKey.friends,
};

// 获取国际化的标题
const getLocalizedName = (name: string): string => {
	const keyValue = navTitleMap[name];
	if (keyValue) {
		return i18n(keyValue as I18nKey);
	}
	return name;
};

type ProcessedNavBarLink = Omit<NavBarLink, "children"> & {
	children?: ProcessedNavBarLink[];
};

// 处理links中的LinkPreset转换
const processedLinks: ProcessedNavBarLink[] = Astro.props.links.map(
	(link: NavBarLink): ProcessedNavBarLink => ({
		...link,
		children: link.children?.map(
			(child: NavBarLink | LinkPreset): ProcessedNavBarLink => {
				if (typeof child === "number") {
					return LinkPresets[child] as ProcessedNavBarLink;
				}
				return child as ProcessedNavBarLink;
			},
		),
	}),
);
---
<div id="nav-menu-panel" class:list={["float-panel float-panel-closed absolute transition-all fixed right-4 px-2 py-2 max-h-[80vh] overflow-y-auto"]}>
    {processedLinks.map((link) => (
        <div class="mobile-menu-item">
            {link.children && link.children.length > 0 ? (
                <!-- 有子菜单的项目 -->
                <div class="mobile-dropdown" data-mobile-dropdown>
                    <button 
                        class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-4 w-full text-left
                            hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition"
                        data-mobile-dropdown-trigger
                        aria-expanded="false"
                    >
                        <div class="flex items-center transition nav-item-text font-bold">
                            {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                            {getLocalizedName(link.name)}
                        </div>
                        <Icon name="material-symbols:keyboard-arrow-down-rounded"
                              class="transition text-[1.25rem] text-(--primary) mobile-dropdown-arrow duration-200"
                        />
                    </button>
                    <div class="mobile-submenu" data-mobile-submenu>
                        {link.children.map((child) => (
                            <a href={child.external ? child.url : url(child.url)} 
                               class="group flex justify-between items-center py-2 pl-6 pr-1 rounded-lg gap-4
                                   hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition"
                               target={child.external ? "_blank" : null}
                            >
                                <div class="flex items-center transition nav-subitem-text font-medium">
                                    {child.icon && <Icon name={child.icon} class="text-[1.1rem] mr-2" />}
                                    {getLocalizedName(child.name)}
                                </div>
                                {child.external && <Icon name="fa7-solid:arrow-up-right-from-square"
                                      class="transition text-[0.75rem] nav-arrow"
                                />}
                            </a>
                        ))}
                    </div>
                </div>
            ) : (
                <!-- 普通链接项目 -->
                <a href={link.external ? link.url : url(link.url)} class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-4
                    hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) transition
                "
                   target={link.external ? "_blank" : null}
                >
                    <div class="flex items-center transition nav-item-text font-bold">
                        {link.icon && <Icon name={link.icon} class="text-[1.1rem] mr-2" />}
                        {getLocalizedName(link.name)}
                    </div>
                    {!link.external && <Icon name="material-symbols:chevron-right-rounded"
                          class="transition text-[1.25rem] text-(--primary)"
                    />}
                    {link.external && <Icon name="fa7-solid:arrow-up-right-from-square"
                          class="transition text-[0.75rem] nav-arrow"
                    />}
                </a>
            )}
        </div>
    ))}
</div>

<style>
    @reference "../../styles/main.css";

    .mobile-submenu {
        @apply max-h-0 overflow-hidden transition-all duration-300 ease-in-out;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-submenu {
        @apply max-h-96;
    }
    
    .mobile-dropdown[data-expanded="true"] .mobile-dropdown-arrow {
        @apply rotate-180;
    }

    .nav-item-text {
        @apply text-black/75 dark:text-white/75;
    }

    .nav-subitem-text {
        @apply text-black/60 dark:text-white/60;
    }

    .nav-arrow {
        @apply text-black/25 dark:text-white/25;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mobileDropdowns = document.querySelectorAll('[data-mobile-dropdown]');
        
        mobileDropdowns.forEach(dropdown => {
            const trigger = dropdown.querySelector('[data-mobile-dropdown-trigger]');
            const submenu = dropdown.querySelector('[data-mobile-submenu]');
            
            if (!trigger || !submenu) return;
            
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                const isExpanded = dropdown.getAttribute('data-expanded') === 'true';
                
                // 关闭其他打开的下拉菜单
                mobileDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        otherDropdown.setAttribute('data-expanded', 'false');
                        const otherTrigger = otherDropdown.querySelector('[data-mobile-dropdown-trigger]');
                        if (otherTrigger) {
                            otherTrigger.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                // 切换当前下拉菜单
                const newState = !isExpanded;
                dropdown.setAttribute('data-expanded', newState.toString());
                trigger.setAttribute('aria-expanded', newState.toString());
            });
        });
    });
</script>
